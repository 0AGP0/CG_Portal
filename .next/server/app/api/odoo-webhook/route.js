"use strict";(()=>{var e={};e.id=3057,e.ids=[3057],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},64939:e=>{e.exports=import("pg")},75577:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{POST:()=>_});var o=a(32190),s=a(5069),i=a(86481),n=e([s]);s=(n.then?(await n)():n)[0];let u="e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",d={name:"name",phone:"phone",contact_address:"contact_address",x_studio_mail_adresi:"email",x_studio_selection_field_8en_1iqnrqang:"stage",stage:"stage",x_studio_doum_tarihi:"birth_date",x_studio_doum_yeri:"birth_place",x_studio_ya:"age",x_studio_medeni_durum_1:"marital_status",x_studio_finansal_kant:"financial_proof",x_studio_pasaport_numaras:"passport_number",x_studio_pasaport_tr:"passport_type",x_studio_verili_tarihi:"passport_issue_date",x_studio_geerlilik_tarihi:"passport_expiry_date",x_studio_veren_makam:"issuing_authority",x_studio_pnr_numaras:"pnr_number",x_studio_anne_ad:"mother_name",x_studio_anne_soyad:"mother_surname",x_studio_anne_doum_tarihi:"mother_birth_date",x_studio_anne_doum_yeri:"mother_birth_place",x_studio_anne_ikamet_sehrilke:"mother_residence",x_studio_anne_telefon:"mother_phone",x_studio_baba_ad:"father_name",x_studio_baba_soyad:"father_surname",x_studio_baba_doum_tarihi:"father_birth_date",x_studio_baba_doum_yeri:"father_birth_place",x_studio_baba_ikamet_ehrilkesi:"father_residence",x_studio_baba_telefon:"father_phone",x_studio_lise_ad:"high_school_name",x_studio_lise_tr:"high_school_type",x_studio_lise_ehir:"high_school_city",x_studio_lise_biti_tarihi:"high_school_graduation_date",x_studio_lise_balang_tarihi_1:"high_school_start_date",x_studio_niversite_ad:"university_name",x_studio_niversite_blm_ad:"university_department",x_studio_niversite_balang_tarihi:"university_start_date",x_studio_niversite_biti_tarihi:"university_end_date",x_studio_mezuniyet_durumu:"graduation_status",x_studio_mezuniyet_yl:"graduation_year",x_studio_almanca_seviyesi_1:"language_level",x_studio_almanca_sertifikas:"language_certificate",x_studio_dil_renim_durumu:"language_learning_status",x_studio_sym_snav_giri:"exam_entry",x_studio_sym_yerlestirme_sonuc_tarihi:"exam_result_date",x_studio_vize_randevu_tarihi:"visa_appointment_date",x_studio_vize_bavuru_tarihi_1:"visa_application_date",x_studio_konsolosluk_1:"visa_consulate",x_studio_vize_randevu_belgesi:"visa_document",x_studio_almanya_bulunma:"has_been_to_germany",x_studio_de_blm_tercihi:"german_department_preference",x_studio_niversite_tercihleri:"university_preferences",x_studio_maddi_kant_durumu:"financial_proof_status",x_studio_bilgiler_1:"additional_info"};function l(e){return/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(e)}async function _(e){console.log("\n=== WEBHOOK İSTEĞİ BAŞLADI ==="),console.log("Zaman:",new Date().toISOString()),console.log("Method:",e.method),console.log("URL:",e.url);let t=Object.fromEntries(e.headers.entries());console.log("Headers:",JSON.stringify(t,null,2));try{let t,a=new URL(e.url).searchParams.get("secret")||"";if(console.log("\nSecret Kontrol\xfc:"),console.log("- Alınan:",a.substring(0,10)+"..."),console.log("- Beklenen:",u.substring(0,10)+"..."),a!==u)return console.error("❌ Ge\xe7ersiz webhook secret"),o.NextResponse.json({error:"Unauthorized - Invalid secret"},{status:401});console.log("✅ Secret doğrulandı");let r=await e.text();console.log("\nHam Veri:",r);try{t=JSON.parse(r),console.log("\nİşlenmiş Veri:",JSON.stringify(t,null,2))}catch(e){return console.error("❌ JSON parse hatası:",e),o.NextResponse.json({error:"Invalid JSON body"},{status:400})}let i=null;if(t.x_studio_mail_adresi&&!1!==t.x_studio_mail_adresi&&""!==t.x_studio_mail_adresi)i=t.x_studio_mail_adresi;else if(t.email&&!1!==t.email&&""!==t.email)i=t.email;else if(t.name&&"string"==typeof t.name&&t.name.includes("@")){let e=t.name.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);e&&(i=e[0])}if(console.log("\nEmail Kontrol\xfc:",i),console.log("Ham email değerleri:",{x_studio_mail_adresi:t.x_studio_mail_adresi,email:t.email,name:t.name}),!i){console.error("❌ Email alanı bulunamadı"),console.log("Mevcut alanlar:",Object.keys(t));{let e=`test_${Date.now()}@example.com`;console.log("⚠️ Test email oluşturuluyor:",e),i=e}}console.log("✅ Email doğrulandı:",i);let n=await s.dz.connect();try{let e;console.log("\n\xd6ğrenci kontrol\xfc yapılıyor...");let a=await n.query("SELECT * FROM students WHERE email = $1",[i]);if(0===a.rows.length){console.log("⚠️ Bu email adresiyle kayıtlı \xf6ğrenci bulunamadı, yeni \xf6ğrenci oluşturuluyor:",i);let a=`
          INSERT INTO students (
            email, name, advisor_email, stage, process_started, created_at, updated_at
          ) VALUES ($1, $2, $3, $4, $5, NOW(), NOW())
          RETURNING *
        `,r=[i,t.name||"Test \xd6ğrenci","test@advisor.com","Hazırlık Aşaması",!0];e=(await n.query(a,r)).rows[0],console.log("✅ Yeni \xf6ğrenci oluşturuldu:",e.name)}else e=a.rows[0],console.log("✅ \xd6ğrenci bulundu:",e.name);console.log("\nG\xfcncellenecek alanlar hazırlanıyor...");let r={};for(let[e,a]of Object.entries(d))if(t.hasOwnProperty(e)){let o=function(e,t){if(null==e||""===e||!1===e)return null;if("string"==typeof e){let a=e.trim();if(""===a)return null;if("graduation_year"===t){if(l(a)){let e=a.split(".");if(3===e.length)return parseInt(e[2],10)}return/^\d{4}$/.test(a)?parseInt(a,10):null}return l(a)?function(e){try{let t=e.split(".");if(3===t.length){let e=t[0].padStart(2,"0"),a=t[1].padStart(2,"0"),r=t[2];return`${r}-${a}-${e}`}}catch(t){console.log("Tarih d\xf6n\xfcşt\xfcrme hatası:",e,t)}return e}(a):a}return e}(t[e],a);null!==o&&(r[a]=o,console.log(`📝 ${e} -> ${a}: ${o}`))}let s=t.x_studio_selection_field_8en_1iqnrqang||t.stage||"";s&&(r.stage=s,console.log(`📝 Stage g\xfcncelleniyor: ${s}`)),console.log("\nG\xfcncellenecek alanlar:",Object.keys(r)),console.log("G\xfcncellenecek değerler:",r);let{query:_,values:u}=function(e){let t=[],a=[],r=1;for(let[o,s]of(t.push("updated_at = NOW()"),t.push("process_started = true"),Object.entries(e)))null!=s&&(t.push(`${o} = $${r}`),a.push(s),r++);return{query:`
    UPDATE students 
    SET ${t.join(", ")}
    WHERE email = $${r}
    RETURNING *
  `,values:a}}(r);u.push(i),console.log("\nSQL Sorgusu:",_),console.log("Parametreler:",u);let c=(await n.query(_,u)).rows[0];return console.log("\n✅ \xd6ğrenci başarıyla g\xfcncellendi"),console.log("G\xfcncellenen alan sayısı:",Object.keys(r).length),console.log("G\xfcncellenen \xf6ğrenci:",JSON.stringify(c,null,2)),o.NextResponse.json({success:!0,message:"\xd6ğrenci bilgileri g\xfcncellendi",updatedFields:Object.keys(r),student:c},{status:200})}finally{n.release()}}catch(e){return console.error("\n❌ Webhook işleme hatası:",e),i.vF.error("Webhook error",e),o.NextResponse.json({error:"Internal server error",details:e.message},{status:500})}finally{console.log("\n=== WEBHOOK İSTEĞİ TAMAMLANDI ===\n")}}r()}catch(e){r(e)}})},94934:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{patchFetch:()=>_,routeModule:()=>u,serverHooks:()=>m,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>c});var o=a(96559),s=a(48088),i=a(37719),n=a(75577),l=e([n]);n=(l.then?(await l)():l)[0];let u=new o.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/odoo-webhook/route",pathname:"/api/odoo-webhook",filename:"route",bundlePath:"app/api/odoo-webhook/route"},resolvedPagePath:"C:\\Users\\pc\\Downloads\\CG_Portal-main\\CG_Portal-main\\src\\app\\api\\odoo-webhook\\route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:d,workUnitAsyncStorage:c,serverHooks:m}=u;function _(){return(0,i.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:c})}r()}catch(e){r(e)}})}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[4447,580,8033],()=>a(94934));module.exports=r})();