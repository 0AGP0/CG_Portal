"use strict";(()=>{var e={};e.id=3057,e.ids=[3057],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},64939:e=>{e.exports=import("pg")},75577:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{POST:()=>l});var a=r(32190),n=r(5069),s=r(86481),i=e([n]);n=(i.then?(await i)():i)[0];let u="e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",d={name:"name",phone:"phone",contact_address:"contact_address",x_studio_mail_adresi:"email",x_studio_selection_field_8en_1iqnrqang:"stage",stage:"stage",x_studio_doum_tarihi:"birth_date",x_studio_doum_yeri:"birth_place",x_studio_ya:"age",x_studio_medeni_durum_1:"marital_status",x_studio_finansal_kant:"financial_proof",x_studio_pasaport_numaras:"passport_number",x_studio_pasaport_tr:"passport_type",x_studio_verili_tarihi:"passport_issue_date",x_studio_geerlilik_tarihi:"passport_expiry_date",x_studio_veren_makam:"issuing_authority",x_studio_pnr_numaras:"pnr_number",x_studio_anne_ad:"mother_name",x_studio_anne_soyad:"mother_surname",x_studio_anne_doum_tarihi:"mother_birth_date",x_studio_anne_doum_yeri:"mother_birth_place",x_studio_anne_ikamet_sehrilke:"mother_residence",x_studio_anne_telefon:"mother_phone",x_studio_baba_ad:"father_name",x_studio_baba_soyad:"father_surname",x_studio_baba_doum_tarihi:"father_birth_date",x_studio_baba_doum_yeri:"father_birth_place",x_studio_baba_ikamet_ehrilkesi:"father_residence",x_studio_baba_telefon:"father_phone",x_studio_lise_ad:"high_school_name",x_studio_lise_tr:"high_school_type",x_studio_lise_ehir:"high_school_city",x_studio_lise_biti_tarihi:"high_school_graduation_date",x_studio_lise_balang_tarihi_1:"high_school_start_date",x_studio_niversite_ad:"university_name",x_studio_niversite_blm_ad:"university_department",x_studio_niversite_balang_tarihi:"university_start_date",x_studio_niversite_biti_tarihi:"university_end_date",x_studio_mezuniyet_durumu:"graduation_status",x_studio_mezuniyet_yl:"graduation_year",x_studio_almanca_seviyesi_1:"language_level",x_studio_almanca_sertifikas:"language_certificate",x_studio_dil_renim_durumu:"language_learning_status",x_studio_sym_snav_giri:"exam_entry",x_studio_sym_yerlestirme_sonuc_tarihi:"exam_result_date",x_studio_vize_randevu_tarihi:"visa_appointment_date",x_studio_vize_bavuru_tarihi_1:"visa_application_date",x_studio_konsolosluk_1:"visa_consulate",x_studio_vize_randevu_belgesi:"visa_document",x_studio_almanya_bulunma:"has_been_to_germany",x_studio_de_blm_tercihi:"german_department_preference",x_studio_niversite_tercihleri:"university_preferences",x_studio_maddi_kant_durumu:"financial_proof_status",x_studio_bilgiler_1:"additional_info"};function _(e){return/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(e)}async function l(e){console.log("\n=== WEBHOOK İSTEĞİ BAŞLADI ==="),console.log("Zaman:",new Date().toISOString()),console.log("Method:",e.method),console.log("URL:",e.url);let t=Object.fromEntries(e.headers.entries());console.log("Headers:",JSON.stringify(t,null,2));try{let t,r=new URL(e.url).searchParams.get("secret")||"";if(console.log("\nSecret Kontrol\xfc:"),console.log("- Alınan:",r.substring(0,10)+"..."),console.log("- Beklenen:",u.substring(0,10)+"..."),r!==u)return console.error("❌ Ge\xe7ersiz webhook secret"),a.NextResponse.json({error:"Unauthorized - Invalid secret"},{status:401});console.log("✅ Secret doğrulandı");let o=await e.text();console.log("\nHam Veri:",o);try{t=JSON.parse(o),console.log("\nİşlenmiş Veri:",JSON.stringify(t,null,2))}catch(e){return console.error("❌ JSON parse hatası:",e),a.NextResponse.json({error:"Invalid JSON body"},{status:400})}let s=t.x_studio_mail_adresi||t.email||null;if(console.log("\nEmail Kontrol\xfc:",s),!s)return console.error("❌ Email alanı bulunamadı"),a.NextResponse.json({error:"Email field is required"},{status:400});console.log("✅ Email doğrulandı");let i=await n.dz.connect();try{console.log("\n\xd6ğrenci kontrol\xfc yapılıyor...");let e=await i.query("SELECT * FROM students WHERE email = $1",[s]);if(0===e.rows.length)return console.error("❌ Bu email adresiyle kayıtlı \xf6ğrenci bulunamadı:",s),a.NextResponse.json({error:"Student not found",message:"Bu email adresiyle kayıtlı \xf6ğrenci bulunamadı",email:s},{status:404});let r=e.rows[0];console.log("✅ \xd6ğrenci bulundu:",r.name),console.log("\nG\xfcncellenecek alanlar hazırlanıyor...");let o={};for(let[e,r]of Object.entries(d))if(t.hasOwnProperty(e)){let a=function(e,t){if(null==e||""===e||!1===e)return null;if("string"==typeof e){let r=e.trim();if(""===r)return null;if("graduation_year"===t){if(_(r)){let e=r.split(".");if(3===e.length)return parseInt(e[2],10)}return/^\d{4}$/.test(r)?parseInt(r,10):null}return _(r)?function(e){try{let t=e.split(".");if(3===t.length){let e=t[0].padStart(2,"0"),r=t[1].padStart(2,"0"),o=t[2];return`${o}-${r}-${e}`}}catch(t){console.log("Tarih d\xf6n\xfcşt\xfcrme hatası:",e,t)}return e}(r):r}return e}(t[e],r);null!==a&&(o[r]=a,console.log(`📝 ${e} -> ${r}: ${a}`))}let n=t.x_studio_selection_field_8en_1iqnrqang||t.stage||"";n&&(o.stage=n,console.log(`📝 Stage g\xfcncelleniyor: ${n}`)),console.log("\nG\xfcncellenecek alanlar:",Object.keys(o)),console.log("G\xfcncellenecek değerler:",o);let{query:l,values:u}=function(e){let t=[],r=[],o=1;for(let[a,n]of(t.push("updated_at = NOW()"),t.push("process_started = true"),Object.entries(e)))null!=n&&(t.push(`${a} = $${o}`),r.push(n),o++);return{query:`
    UPDATE students 
    SET ${t.join(", ")}
    WHERE email = $${o}
    RETURNING *
  `,values:r}}(o);u.push(s),console.log("\nSQL Sorgusu:",l),console.log("Parametreler:",u);let c=(await i.query(l,u)).rows[0];return console.log("\n✅ \xd6ğrenci başarıyla g\xfcncellendi"),console.log("G\xfcncellenen alan sayısı:",Object.keys(o).length),console.log("G\xfcncellenen \xf6ğrenci:",JSON.stringify(c,null,2)),a.NextResponse.json({success:!0,message:"\xd6ğrenci bilgileri g\xfcncellendi",updatedFields:Object.keys(o),student:c},{status:200})}finally{i.release()}}catch(e){return console.error("\n❌ Webhook işleme hatası:",e),s.vF.error("Webhook error",e),a.NextResponse.json({error:"Internal server error",details:e.message},{status:500})}finally{console.log("\n=== WEBHOOK İSTEĞİ TAMAMLANDI ===\n")}}o()}catch(e){o(e)}})},94934:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{patchFetch:()=>l,routeModule:()=>u,serverHooks:()=>p,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>c});var a=r(96559),n=r(48088),s=r(37719),i=r(75577),_=e([i]);i=(_.then?(await _)():_)[0];let u=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/odoo-webhook/route",pathname:"/api/odoo-webhook",filename:"route",bundlePath:"app/api/odoo-webhook/route"},resolvedPagePath:"C:\\Users\\pc\\Downloads\\CG_Portal-main\\CG_Portal-main\\src\\app\\api\\odoo-webhook\\route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:d,workUnitAsyncStorage:c,serverHooks:p}=u;function l(){return(0,s.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:c})}o()}catch(e){o(e)}})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[4447,580,8033],()=>r(94934));module.exports=o})();