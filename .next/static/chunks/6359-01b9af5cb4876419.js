"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6359],{6359:(e,r,a)=>{a.d(r,{KZ:()=>o,Ow:()=>l,Q4:()=>u});var t=a(6072),i=a(9576);a(8022);var n=a(9723);let s=async(e,r)=>{try{let a={"Content-Type":"application/json"};r&&(a["x-user-email"]=r);let t=await fetch(e,{headers:a});if(!t.ok){let e=await t.json();throw Error(e.error||"Veri getirme hatası")}return t.json()}catch(e){throw n.vF.error("Fetcher hatası:",e),e}};function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3e4,{user:r}=(0,i.A)(),a=!!(null==r?void 0:r.email),{data:o,error:l,isLoading:u,isValidating:d,mutate:c}=(0,t.Ay)(a?"/api/messages/unread":null,e=>s(e,null==r?void 0:r.email),{refreshInterval:e,revalidateOnFocus:!0,revalidateIfStale:!0,dedupingInterval:5e3,onError:e=>{n.vF.error("Okunmamış mesaj sayısı getirme hatası:",e)}});return{unreadCount:(null==o?void 0:o.unreadCount)||0,isLoading:u,isError:l,isValidating:d,mutate:c}}function l(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3e4,{user:r}=(0,i.A)(),a=!!((null==r?void 0:r.email)&&(null==r?void 0:r.role)==="advisor"),{data:o,error:l,isLoading:u,isValidating:d,mutate:c}=(0,t.Ay)(a?"/api/advisor/students":null,e=>s(e,null==r?void 0:r.email),{refreshInterval:e,revalidateOnFocus:!1,revalidateIfStale:!0,dedupingInterval:5e3,onError:e=>{n.vF.error("\xd6ğrenci listesi getirme hatası:",e)}});return{students:(null==o?void 0:o.success)?o.students:[],isLoading:u,isError:l,isValidating:d,mutate:c}}function u(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4,{user:a}=(0,i.A)(),n=!!((null==a?void 0:a.email)&&(null==a?void 0:a.role)==="advisor"&&e),{data:o,error:l,isLoading:u,isValidating:d,mutate:c}=(0,t.Ay)(n?"".concat("/api/advisor/students/").concat(encodeURIComponent(e)):null,s,{refreshInterval:r,revalidateOnFocus:!0,revalidateIfStale:!0,dedupingInterval:2e3});return{student:o,isLoading:u,isError:l,isValidating:d,mutate:c}}},8022:(e,r,a)=>{a.d(r,{MessagesProvider:()=>c,o:()=>d});var t=a(5155),i=a(2115),n=a(9576),s=a(7383);let o=e=>s.A.get(e),l=(e,r)=>{s.A.remove(e,r)},u=(0,i.createContext)({tickets:[],unreadCount:0,selectedTicketId:null,selectTicket:()=>{},sendMessage:()=>{},createNewTicket:()=>{},markAsRead:()=>{},refreshMessages:()=>{},setTickets:()=>{},isLoading:!0,isSending:!1,error:null}),d=()=>(0,i.useContext)(u),c=e=>{let{children:r}=e,{user:a,isLoading:s}=(0,n.A)(),[d,c]=(0,i.useState)([]),[m,g]=(0,i.useState)(null),[f,h]=(0,i.useState)(0),[v,p]=(0,i.useState)(!0),[y,k]=(0,i.useState)(!1),[w,j]=(0,i.useState)(null),E=async()=>{try{if(!a||s){console.log("Kullanıcı giriş yapmamış veya oturum y\xfckleniyor"),c([]),p(!1);return}if("admin"===a.role){console.log("Admin i\xe7in mesaj sistemi devre dışı"),c([]),p(!1);return}j(null),p(!0);let e=o("token");if(!e){console.error("Token bulunamadı"),j("Oturum s\xfcresi dolmuş. L\xfctfen tekrar giriş yapın."),c([]),p(!1);return}console.log("Mesajlar getiriliyor, kullanıcı:",a);let r="advisor"===a.role?"/api/advisor/messages":"/api/student/messages";console.log("Mesaj API endpoint:",r);let t=await fetch(r,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e),"x-user-email":a.email,"x-user-role":a.role},credentials:"include"});if(console.log("Mesaj API yanıtı:",t.status),!t.ok){let e=await t.json().catch(()=>({}));throw console.error("Mesaj API hata detayı:",e),401===t.status?(j("Oturum s\xfcresi dolmuş. L\xfctfen tekrar giriş yapın."),l("token"),l("user"),window.location.href="/login"):404===t.status?j("Mesaj verileri bulunamadı."):500===t.status?j("Sunucu hatası. L\xfctfen daha sonra tekrar deneyin."):j(e.error||"Mesaj verileri alınamadı"),c([]),Error(e.error||"Mesaj verileri alınamadı")}let i=await t.json();if(console.log("Alınan mesaj verileri:",i),!i.success){j(i.error||"Mesaj verileri alınamadı"),c([]);return}if(i.tickets){let e=i.tickets.sort((e,r)=>new Date(r.date).getTime()-new Date(e.date).getTime());c(e)}else console.warn("Mesaj verisi boş veya beklenmeyen format:",i),c([])}catch(e){console.error("Mesaj verileri alınamadı:",e),j(e instanceof Error?e.message:"Mesajlar y\xfcklenirken bir hata oluştu. L\xfctfen sayfayı yenileyin."),c([])}finally{p(!1)}};(0,i.useEffect)(()=>{a&&!s?(p(!0),E()):(c([]),p(!1))},[a,s]),(0,i.useEffect)(()=>{h(d.filter(e=>!e.isRead).length)},[d]);let S=e=>{c(r=>r.map(r=>r.id===e?{...r,isRead:!0}:r))};d.find(e=>e.id===m);let b=async(e,r)=>{if(!a)return void j("Mesaj g\xf6ndermek i\xe7in giriş yapmalısınız.");try{j(null),k(!0);let t=o("token");if(!t){j("Oturum s\xfcresi dolmuş. L\xfctfen tekrar giriş yapın."),window.location.href="/login";return}let i="";if("student"===a.role){let e=await fetch("/api/student/profile",{headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t),"x-user-email":a.email,"x-user-role":a.role},credentials:"include"});if(!e.ok)throw Error("Danışman bilgisi alınamadı");let r=await e.json();if(!r.success||!r.student||!r.student.advisor_email)throw Error("Danışman bilgisi bulunamadı");i=r.student.advisor_email}else if("advisor"===a.role&&!(i=e.studentEmail||e.studentId||""))throw Error("\xd6ğrenci e-posta adresi bulunamadı");let n=await fetch("/api/messages/send",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t),"x-user-email":a.email,"x-user-role":a.role},credentials:"include",body:JSON.stringify({receiverEmail:i,content:r,senderRole:a.role,subject:e.subject})}),s=await n.json();if(!n.ok||!s.success)throw Error(s.error||"Mesaj g\xf6nderilemedi");let l={sender:"user",content:r,timestamp:new Date().toISOString()};c(a=>a.map(a=>a.id===e.id?{...a,messages:[...a.messages,l],preview:r,date:new Date().toISOString()}:a))}catch(e){console.error("Mesaj g\xf6nderme hatası:",e),j(e instanceof Error?e.message:"Mesaj g\xf6nderilirken bir hata oluştu")}finally{k(!1)}},A=async(e,r)=>{if(!a)return void j("Yeni konu oluşturmak i\xe7in giriş yapmalısınız.");try{if(j(null),k(!0),"student"===a.role){let t=await fetch("/api/student/profile",{headers:{"x-user-email":a.email,"Content-Type":"application/json",Authorization:"Bearer ".concat(o("token"))}});if(!t.ok)throw Error("Danışman bilgisi alınamadı");let i=await t.json();if(!i.success||!i.student||!i.student.advisor_email)throw Error("Danışman bilgisi bulunamadı");let n=await fetch("/api/messages/send",{method:"POST",headers:{"Content-Type":"application/json","x-user-email":a.email,Authorization:"Bearer ".concat(o("token"))},body:JSON.stringify({receiverEmail:i.student.advisor_email,content:r,senderRole:a.role,subject:e,category:"general"})}),s=await n.json();if(!n.ok||!s.success)throw Error(s.error||"Yeni konu oluşturulamadı");let l={id:Date.now(),subject:e,preview:r,date:new Date().toISOString(),isRead:!0,studentEmail:a.email,studentName:a.name,messages:[{sender:"user",content:r,timestamp:new Date().toISOString()}]};c(e=>[l,...e]),g(l.id)}else if("advisor"===a.role)throw Error("Danışmanlar i\xe7in \xf6ğrenci e-posta adresi gereklidir");else throw Error("Sadece \xf6ğrenciler yeni konu oluşturabilir")}catch(e){console.error("Yeni konu oluşturma hatası:",e),j(e instanceof Error?e.message:"Yeni konu oluşturulurken bir hata oluştu")}finally{k(!1)}};return(0,t.jsx)(u.Provider,{value:{tickets:d,unreadCount:f,selectedTicketId:m,selectTicket:e=>{g(e),S(e)},sendMessage:b,createNewTicket:A,markAsRead:S,refreshMessages:()=>{a&&!s&&E()},setTickets:c,isLoading:v,isSending:y,error:w},children:r})}}}]);