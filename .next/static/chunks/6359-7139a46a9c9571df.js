"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6359],{6359:(e,r,t)=>{t.d(r,{KZ:()=>o,Ow:()=>l,Q4:()=>u});var a=t(6072),n=t(9576);t(8022);var i=t(9723);let s=async(e,r)=>{try{let t={"Content-Type":"application/json"};r&&(t["x-user-email"]=r);let a=await fetch(e,{headers:t});if(!a.ok){let e=await a.json();throw Error(e.error||"Veri getirme hatası")}return a.json()}catch(e){throw i.vF.error("Fetcher hatası:",e),e}};function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3e4,{user:r}=(0,n.A)(),t=!!(null==r?void 0:r.email),{data:o,error:l,isLoading:u,isValidating:d,mutate:c}=(0,a.Ay)(t?"/api/messages/unread":null,e=>s(e,null==r?void 0:r.email),{refreshInterval:e,revalidateOnFocus:!0,revalidateIfStale:!0,dedupingInterval:5e3,onError:e=>{i.vF.error("Okunmamış mesaj sayısı getirme hatası:",e)}});return{unreadCount:(null==o?void 0:o.unreadCount)||0,isLoading:u,isError:l,isValidating:d,mutate:c}}function l(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];let{user:e}=(0,n.A)(),r=!!((null==e?void 0:e.email)&&(null==e?void 0:e.role)==="advisor"),t="/api/advisor/students";console.log("useStudents hook debug:",{user:e?{email:e.email,role:e.role}:null,shouldFetch:r,endpoint:t});let{data:o,error:l,isLoading:u,isValidating:d,mutate:c}=(0,a.Ay)(r?t:null,r=>s(r,null==e?void 0:e.email),{refreshInterval:0,revalidateOnFocus:!1,revalidateIfStale:!1,dedupingInterval:1e4,errorRetryCount:1,errorRetryInterval:5e3,onError:e=>{i.vF.error("\xd6ğrenci listesi getirme hatası:",e),console.error("useStudents hook error:",e)},onSuccess:e=>{console.log("useStudents hook success:",e)}}),m=(null==o?void 0:o.success)?o.students:[];return console.log("useStudents hook result:",{data:o,students:m.length,isLoading:u,isError:l}),{students:m,isLoading:u,isError:l,isValidating:d,mutate:c}}function u(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4,{user:t}=(0,n.A)(),i=!!((null==t?void 0:t.email)&&(null==t?void 0:t.role)==="advisor"&&e),{data:o,error:l,isLoading:u,isValidating:d,mutate:c}=(0,a.Ay)(i?"".concat("/api/advisor/students/").concat(encodeURIComponent(e)):null,s,{refreshInterval:r,revalidateOnFocus:!0,revalidateIfStale:!0,dedupingInterval:2e3});return{student:o,isLoading:u,isError:l,isValidating:d,mutate:c}}},8022:(e,r,t)=>{t.d(r,{MessagesProvider:()=>c,o:()=>d});var a=t(5155),n=t(2115),i=t(9576),s=t(7383);let o=e=>s.A.get(e),l=(e,r)=>{s.A.remove(e,r)},u=(0,n.createContext)({tickets:[],unreadCount:0,selectedTicketId:null,selectTicket:()=>{},sendMessage:()=>{},createNewTicket:()=>{},markAsRead:()=>{},refreshMessages:()=>{},setTickets:()=>{},isLoading:!0,isSending:!1,error:null}),d=()=>(0,n.useContext)(u),c=e=>{let{children:r}=e,{user:t,isLoading:s}=(0,i.A)(),[d,c]=(0,n.useState)([]),[m,g]=(0,n.useState)(null),[h,f]=(0,n.useState)(0),[v,p]=(0,n.useState)(!0),[k,y]=(0,n.useState)(!1),[w,j]=(0,n.useState)(null),S=async()=>{try{if(!t||s){console.log("Kullanıcı giriş yapmamış veya oturum y\xfckleniyor"),c([]),p(!1);return}if("admin"===t.role){console.log("Admin i\xe7in mesaj sistemi devre dışı"),c([]),p(!1);return}j(null),p(!0);let e=o("token");if(!e){console.error("Token bulunamadı"),j("Oturum s\xfcresi dolmuş. L\xfctfen tekrar giriş yapın."),c([]),p(!1);return}console.log("Mesajlar getiriliyor, kullanıcı:",t);let r="advisor"===t.role?"/api/advisor/messages":"/api/student/messages";console.log("Mesaj API endpoint:",r);let a=await fetch(r,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e),"x-user-email":t.email,"x-user-role":t.role},credentials:"include"});if(console.log("Mesaj API yanıtı:",a.status),!a.ok){let e=await a.json().catch(()=>({}));throw console.error("Mesaj API hata detayı:",e),401===a.status?(j("Oturum s\xfcresi dolmuş. L\xfctfen tekrar giriş yapın."),l("token"),l("user"),window.location.href="/login"):404===a.status?j("Mesaj verileri bulunamadı."):500===a.status?j("Sunucu hatası. L\xfctfen daha sonra tekrar deneyin."):j(e.error||"Mesaj verileri alınamadı"),c([]),Error(e.error||"Mesaj verileri alınamadı")}let n=await a.json();if(console.log("Alınan mesaj verileri:",n),!n.success){j(n.error||"Mesaj verileri alınamadı"),c([]);return}if(n.tickets){let e=n.tickets.sort((e,r)=>new Date(r.date).getTime()-new Date(e.date).getTime());c(e)}else console.warn("Mesaj verisi boş veya beklenmeyen format:",n),c([])}catch(e){console.error("Mesaj verileri alınamadı:",e),j(e instanceof Error?e.message:"Mesajlar y\xfcklenirken bir hata oluştu. L\xfctfen sayfayı yenileyin."),c([])}finally{p(!1)}};(0,n.useEffect)(()=>{t&&!s?(p(!0),S()):(c([]),p(!1))},[t,s]),(0,n.useEffect)(()=>{f(d.filter(e=>!e.isRead).length)},[d]);let E=e=>{c(r=>r.map(r=>r.id===e?{...r,isRead:!0}:r))};d.find(e=>e.id===m);let b=async(e,r)=>{if(!t)return void j("Mesaj g\xf6ndermek i\xe7in giriş yapmalısınız.");try{j(null),y(!0);let a=o("token");if(!a){j("Oturum s\xfcresi dolmuş. L\xfctfen tekrar giriş yapın."),window.location.href="/login";return}let n="";if("student"===t.role){let e=await fetch("/api/student/profile",{headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a),"x-user-email":t.email,"x-user-role":t.role},credentials:"include"});if(!e.ok)throw Error("Danışman bilgisi alınamadı");let r=await e.json();if(!r.success||!r.student||!r.student.advisor_email)throw Error("Danışman bilgisi bulunamadı");n=r.student.advisor_email}else if("advisor"===t.role&&!(n=e.studentEmail||e.studentId||""))throw Error("\xd6ğrenci e-posta adresi bulunamadı");let i=await fetch("/api/messages/send",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a),"x-user-email":t.email,"x-user-role":t.role},credentials:"include",body:JSON.stringify({receiverEmail:n,content:r,senderRole:t.role,subject:e.subject})}),s=await i.json();if(!i.ok||!s.success)throw Error(s.error||"Mesaj g\xf6nderilemedi");let l={sender:"user",content:r,timestamp:new Date().toISOString()};c(t=>t.map(t=>t.id===e.id?{...t,messages:[...t.messages,l],preview:r,date:new Date().toISOString()}:t))}catch(e){console.error("Mesaj g\xf6nderme hatası:",e),j(e instanceof Error?e.message:"Mesaj g\xf6nderilirken bir hata oluştu")}finally{y(!1)}},A=async(e,r)=>{if(!t)return void j("Yeni konu oluşturmak i\xe7in giriş yapmalısınız.");try{if(j(null),y(!0),"student"===t.role){let a=await fetch("/api/student/profile",{headers:{"x-user-email":t.email,"Content-Type":"application/json",Authorization:"Bearer ".concat(o("token"))}});if(!a.ok)throw Error("Danışman bilgisi alınamadı");let n=await a.json();if(!n.success||!n.student||!n.student.advisor_email)throw Error("Danışman bilgisi bulunamadı");let i=await fetch("/api/messages/send",{method:"POST",headers:{"Content-Type":"application/json","x-user-email":t.email,Authorization:"Bearer ".concat(o("token"))},body:JSON.stringify({receiverEmail:n.student.advisor_email,content:r,senderRole:t.role,subject:e,category:"general"})}),s=await i.json();if(!i.ok||!s.success)throw Error(s.error||"Yeni konu oluşturulamadı");let l={id:Date.now(),subject:e,preview:r,date:new Date().toISOString(),isRead:!0,studentEmail:t.email,studentName:t.name,messages:[{sender:"user",content:r,timestamp:new Date().toISOString()}]};c(e=>[l,...e]),g(l.id)}else if("advisor"===t.role)throw Error("Danışmanlar i\xe7in \xf6ğrenci e-posta adresi gereklidir");else throw Error("Sadece \xf6ğrenciler yeni konu oluşturabilir")}catch(e){console.error("Yeni konu oluşturma hatası:",e),j(e instanceof Error?e.message:"Yeni konu oluşturulurken bir hata oluştu")}finally{y(!1)}};return(0,a.jsx)(u.Provider,{value:{tickets:d,unreadCount:h,selectedTicketId:m,selectTicket:e=>{g(e),E(e)},sendMessage:b,createNewTicket:A,markAsRead:E,refreshMessages:()=>{t&&!s&&S()},setTickets:c,isLoading:v,isSending:k,error:w},children:r})}}}]);