(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7177],{347:()=>{},5356:e=>{e.exports={style:{fontFamily:"'Inter', 'Inter Fallback'",fontStyle:"normal"},className:"__className_e8ce0c"}},7383:(e,r,t)=>{"use strict";function a(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var a in t)e[a]=t[a]}return e}t.d(r,{A:()=>n});var n=function e(r,t){function n(e,n,i){if("undefined"!=typeof document){"number"==typeof(i=a({},t,i)).expires&&(i.expires=new Date(Date.now()+864e5*i.expires)),i.expires&&(i.expires=i.expires.toUTCString()),e=encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var o="";for(var s in i)i[s]&&(o+="; "+s,!0!==i[s]&&(o+="="+i[s].split(";")[0]));return document.cookie=e+"="+r.write(n,e)+o}}return Object.create({set:n,get:function(e){if("undefined"!=typeof document&&(!arguments.length||e)){for(var t=document.cookie?document.cookie.split("; "):[],a={},n=0;n<t.length;n++){var i=t[n].split("="),o=i.slice(1).join("=");try{var s=decodeURIComponent(i[0]);if(a[s]=r.read(o,s),e===s)break}catch(e){}}return e?a[e]:a}},remove:function(e,r){n(e,"",a({},r,{expires:-1}))},withAttributes:function(r){return e(this.converter,a({},this.attributes,r))},withConverter:function(r){return e(a({},this.converter,r),this.attributes)}},{attributes:{value:Object.freeze(t)},converter:{value:Object.freeze(r)}})}({read:function(e){return'"'===e[0]&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"})},8022:(e,r,t)=>{"use strict";t.d(r,{MessagesProvider:()=>d,o:()=>c});var a=t(5155),n=t(2115),i=t(9576),o=t(7383);let s=e=>o.A.get(e),l=(e,r)=>{o.A.remove(e,r)},u=(0,n.createContext)({tickets:[],unreadCount:0,selectedTicketId:null,selectTicket:()=>{},sendMessage:()=>{},createNewTicket:()=>{},markAsRead:()=>{},refreshMessages:()=>{},setTickets:()=>{},isLoading:!0,isSending:!1,error:null}),c=()=>(0,n.useContext)(u),d=e=>{let{children:r}=e,{user:t,isLoading:o}=(0,i.A)(),[c,d]=(0,n.useState)([]),[m,f]=(0,n.useState)(null),[p,h]=(0,n.useState)(0),[g,v]=(0,n.useState)(!0),[k,y]=(0,n.useState)(!1),[w,b]=(0,n.useState)(null),j=async()=>{try{if(!t||o){console.log("Kullanıcı giriş yapmamış veya oturum y\xfckleniyor"),d([]),v(!1);return}if("admin"===t.role){console.log("Admin i\xe7in mesaj sistemi devre dışı"),d([]),v(!1);return}b(null),v(!0);let e=s("token");if(!e){console.error("Token bulunamadı"),b("Oturum s\xfcresi dolmuş. L\xfctfen tekrar giriş yapın."),d([]),v(!1);return}console.log("Mesajlar getiriliyor, kullanıcı:",t);let r="advisor"===t.role?"/api/advisor/messages":"/api/student/messages";console.log("Mesaj API endpoint:",r);let a=await fetch(r,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e),"x-user-email":t.email,"x-user-role":t.role},credentials:"include"});if(console.log("Mesaj API yanıtı:",a.status),!a.ok){let e=await a.json().catch(()=>({}));throw console.error("Mesaj API hata detayı:",e),401===a.status?(b("Oturum s\xfcresi dolmuş. L\xfctfen tekrar giriş yapın."),l("token"),l("user"),window.location.href="/login"):404===a.status?b("Mesaj verileri bulunamadı."):500===a.status?b("Sunucu hatası. L\xfctfen daha sonra tekrar deneyin."):b(e.error||"Mesaj verileri alınamadı"),d([]),Error(e.error||"Mesaj verileri alınamadı")}let n=await a.json();if(console.log("Alınan mesaj verileri:",n),!n.success){b(n.error||"Mesaj verileri alınamadı"),d([]);return}if(n.tickets){let e=n.tickets.sort((e,r)=>new Date(r.date).getTime()-new Date(e.date).getTime());d(e)}else console.warn("Mesaj verisi boş veya beklenmeyen format:",n),d([])}catch(e){console.error("Mesaj verileri alınamadı:",e),b(e instanceof Error?e.message:"Mesajlar y\xfcklenirken bir hata oluştu. L\xfctfen sayfayı yenileyin."),d([])}finally{v(!1)}};(0,n.useEffect)(()=>{t&&!o?(v(!0),j()):(d([]),v(!1))},[t,o]),(0,n.useEffect)(()=>{h(c.filter(e=>!e.isRead).length)},[c]);let E=e=>{d(r=>r.map(r=>r.id===e?{...r,isRead:!0}:r))};c.find(e=>e.id===m);let S=async(e,r)=>{if(!t)return void b("Mesaj g\xf6ndermek i\xe7in giriş yapmalısınız.");try{b(null),y(!0);let a=s("token");if(!a){b("Oturum s\xfcresi dolmuş. L\xfctfen tekrar giriş yapın."),window.location.href="/login";return}let n="";if("student"===t.role){let e=await fetch("/api/student/profile",{headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a),"x-user-email":t.email,"x-user-role":t.role},credentials:"include"});if(!e.ok)throw Error("Danışman bilgisi alınamadı");let r=await e.json();if(!r.success||!r.student||!r.student.advisor_email)throw Error("Danışman bilgisi bulunamadı");n=r.student.advisor_email}else if("advisor"===t.role&&!(n=e.studentEmail||e.studentId||""))throw Error("\xd6ğrenci e-posta adresi bulunamadı");let i=await fetch("/api/messages/send",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a),"x-user-email":t.email,"x-user-role":t.role},credentials:"include",body:JSON.stringify({receiverEmail:n,content:r,senderRole:t.role,subject:e.subject})}),o=await i.json();if(!i.ok||!o.success)throw Error(o.error||"Mesaj g\xf6nderilemedi");let l={sender:"user",content:r,timestamp:new Date().toISOString()};d(t=>t.map(t=>t.id===e.id?{...t,messages:[...t.messages,l],preview:r,date:new Date().toISOString()}:t))}catch(e){console.error("Mesaj g\xf6nderme hatası:",e),b(e instanceof Error?e.message:"Mesaj g\xf6nderilirken bir hata oluştu")}finally{y(!1)}},C=async(e,r)=>{if(!t)return void b("Yeni konu oluşturmak i\xe7in giriş yapmalısınız.");try{if(b(null),y(!0),"student"===t.role){let a=await fetch("/api/student/profile",{headers:{"x-user-email":t.email,"Content-Type":"application/json",Authorization:"Bearer ".concat(s("token"))}});if(!a.ok)throw Error("Danışman bilgisi alınamadı");let n=await a.json();if(!n.success||!n.student||!n.student.advisor_email)throw Error("Danışman bilgisi bulunamadı");let i=await fetch("/api/messages/send",{method:"POST",headers:{"Content-Type":"application/json","x-user-email":t.email,Authorization:"Bearer ".concat(s("token"))},body:JSON.stringify({receiverEmail:n.student.advisor_email,content:r,senderRole:t.role,subject:e,category:"general"})}),o=await i.json();if(!i.ok||!o.success)throw Error(o.error||"Yeni konu oluşturulamadı");let l={id:Date.now(),subject:e,preview:r,date:new Date().toISOString(),isRead:!0,studentEmail:t.email,studentName:t.name,messages:[{sender:"user",content:r,timestamp:new Date().toISOString()}]};d(e=>[l,...e]),f(l.id)}else if("advisor"===t.role)throw Error("Danışmanlar i\xe7in \xf6ğrenci e-posta adresi gereklidir");else throw Error("Sadece \xf6ğrenciler yeni konu oluşturabilir")}catch(e){console.error("Yeni konu oluşturma hatası:",e),b(e instanceof Error?e.message:"Yeni konu oluşturulurken bir hata oluştu")}finally{y(!1)}};return(0,a.jsx)(u.Provider,{value:{tickets:c,unreadCount:p,selectedTicketId:m,selectTicket:e=>{f(e),E(e)},sendMessage:S,createNewTicket:C,markAsRead:E,refreshMessages:()=>{t&&!o&&j()},setTickets:d,isLoading:g,isSending:k,error:w},children:r})}},9291:(e,r,t)=>{Promise.resolve().then(t.t.bind(t,5356,23)),Promise.resolve().then(t.t.bind(t,347,23)),Promise.resolve().then(t.bind(t,9576)),Promise.resolve().then(t.bind(t,1506)),Promise.resolve().then(t.bind(t,8022)),Promise.resolve().then(t.bind(t,5573))}},e=>{var r=r=>e(e.s=r);e.O(0,[9897,7690,5573,4288,7706,7544,1142,2993,1561,6867,5495,7358],()=>r(9291)),_N_E=e.O()}]);